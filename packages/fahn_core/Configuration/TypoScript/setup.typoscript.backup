# ==================================================================
# FAHN-CORE Production API Configuration
# Package: packages/fahn_core
# File: Configuration/TypoScript/setup.typoscript
# ==================================================================
# Diese Konfiguration implementiert eine produktionsreife API-Architektur
# mit TypoScript-basiertem Routing und cHash-Remediation
# ==================================================================

# ==================================================================
# Plugin-Definitionen (USER-Objekte für flexibles Routing)
# ==================================================================

# ------------------------------------------
# Plugin: Fahndung API
# ------------------------------------------
plugin.tx_fahncorefahndung_api = USER
plugin.tx_fahncorefahndung_api {
    # Manueller Bootstrap des Extbase-Frameworks
    userFunc = TYPO3\CMS\Extbase\Core\Bootstrap->run
    extensionName = FahnCoreFahndung
    pluginName = Api
    vendorName = Fahn
    controller = Fahndung
    
    # FEATURE TOGGLE: cHash Resolution Strategy
    # Durch das Überspringen der Default-Argumente in der Link-Generierung
    # und URL-Auflösung verhindern wir Redundanzen, die den Hash ungültig machen.
    features {
        skipDefaultArguments = 1
    }
    
    # Fallback-Strategie für Robustheit
    mvc {
        callDefaultActionIfActionCantBeResolved = 1
    }
}

# ------------------------------------------
# Plugin: Login API
# ------------------------------------------
plugin.tx_fahncore_login = USER
plugin.tx_fahncore_login {
    userFunc = TYPO3\CMS\Extbase\Core\Bootstrap->run
    extensionName = FahnCore
    pluginName = Login
    vendorName = Fahn
    controller = Login
    
    features {
        skipDefaultArguments = 1
    }
    
    mvc {
        callDefaultActionIfActionCantBeResolved = 1
    }
}

# ==================================================================
# API Router Logic (CASE Dispatcher)
# ==================================================================
lib.fahn_core_api_router = COA
lib.fahn_core_api_router {
    # --------------------------------------
    # Route 1: Fahndung Controller Dispatcher
    # --------------------------------------
    10 = CASE
    10 {
        # Der Key ist der 'action'-Parameter im Plugin-Namespace
        key.data = GP:tx_fahncorefahndung_api|action

        # Mapping: action=list -> Fahndung->listAction()
        list = USER
        list < plugin.tx_fahncorefahndung_api
        list.action = list

        # Mapping: action=show -> Fahndung->showAction()
        show = USER
        show < plugin.tx_fahncorefahndung_api
        show.action = show

        # Mapping: action=create -> Fahndung->createAction()
        create = USER
        create < plugin.tx_fahncorefahndung_api
        create.action = create

        # Mapping: action=update -> Fahndung->updateAction()
        update = USER
        update < plugin.tx_fahncorefahndung_api
        update.action = update

        # Mapping: action=delete -> Fahndung->deleteAction()
        delete = USER
        delete < plugin.tx_fahncorefahndung_api
        delete.action = delete
        
        # Default: Fehler-JSON bei unbekannter Action
        default = TEXT
        default.value = {"error": "Invalid action or endpoint not found"}
        
        # Bedingung: Dieser Block läuft nur, wenn der Namespace präsent ist
        if.isTrue.data = GP:tx_fahncorefahndung_api
    }

    # --------------------------------------
    # Route 2: Login Controller Dispatcher
    # --------------------------------------
    20 = CASE
    20 {
        key.data = GP:tx_fahncore_login|action

        login = USER
        login < plugin.tx_fahncore_login
        login.action = login

        session = USER
        session < plugin.tx_fahncore_login
        session.action = session

        logout = USER
        logout < plugin.tx_fahncore_login
        logout.action = logout
        
        default = TEXT
        default.value = {"error": "Invalid action or endpoint not found"}
        
        if.isTrue.data = GP:tx_fahncore_login
    }
}

# ==================================================================
# Page-Konfiguration (nur aktiv wenn API-Parameter vorhanden)
# ==================================================================
# Überschreibe die Standard-Page-Konfiguration nur wenn API-Parameter vorhanden sind
[globalVar = GP:tx_fahncore_login|action != ""] || [globalVar = GP:tx_fahncorefahndung_api|action != ""]
    page = PAGE
    page {
        typeNum = 0

        config {
            # ------------------------------------------
            # Rendering-Basis
            # ------------------------------------------
            # Deaktiviert <head>, <body>, CSS, JS Inklusionen komplett.
            # Das Resultat ist ein leerer Buffer, den wir mit JSON füllen.
            disableAllHeaderCode = 1

            # Caching-Strategie 
            # Wir aktivieren den Cache (no_cache = 0), steuern ihn aber granular.
            # Ein generelles Abschalten würde die Performance massiv gefährden.
            no_cache = 0
            
            # Cache-Lebensdauer: 5 Minuten (300 Sekunden).
            # Dies ist ein Kompromiss aus Aktualität und Entlastung der Datenbank.
            cache_period = 300
            
            # Wichtig für Next.js ISR (Incremental Static Regeneration):
            # Sendet Last-Modified und ETag Header.
            sendCacheHeaders = 1

            # ------------------------------------------
            # Lokalisierung
            # ------------------------------------------
            language = de
            locale_all = de_DE.UTF-8
            htmlTag_langKey = de

            # ------------------------------------------
            # Security Headers (Hardening)
            # ------------------------------------------
            additionalHeaders {
                # 1. Content-Type Sniffing Schutz
                10.header = X-Content-Type-Options: nosniff
                
                # 2. Clickjacking Schutz (Verhindert Einbetten in iFrames)
                20.header = X-Frame-Options: SAMEORIGIN
                
                # 3. XSS Filter für ältere Browser
                30.header = X-XSS-Protection: 1; mode=block
                
                # 4. Referrer Policy für Datenschutz
                40.header = Referrer-Policy: strict-origin-when-cross-origin

                # ------------------------------------------
                # CORS Konfiguration (Cross-Origin Resource Sharing)
                # ------------------------------------------
                # Der Origin wird dynamisch aus Konstanten geladen, um
                # zwischen Dev (localhost) und Prod (polizei-bw.de) zu unterscheiden.
                50.header = Access-Control-Allow-Origin: {$fahn.api.corsOrigin}
                
                # KRITISCH: Erlaubt das Senden von Cookies (fe_typo_user).
                # Ohne diesen Header schlägt die Session-Auth fehl.
                60.header = Access-Control-Allow-Credentials: true
                
                # Erlaubte Methoden
                70.header = Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
                
                # Erlaubte Header im Request
                80.header = Access-Control-Allow-Headers: Content-Type, Authorization
                
                # Content-Type für JSON
                90.header = Content-Type: application/json; charset=utf-8
            }
        }

        # API-Router wird direkt verwendet
        # OPTIONS-Requests werden bereits von CorsMiddleware behandelt
        10 < lib.fahn_core_api_router
    }
[global]

# ==================================================================
# PRODUKTIONSREIFE KONFIGURATION: lib.page für explizite JSON-Struktur
# ==================================================================
# This follows the headless extension's expected structure
lib.page = JSON
lib.page {
    fields {
        # Standard headless page structure
        content = CONTENT_JSON
        content {
            table = tt_content
            select {
                orderBy = sorting
                where = {#colPos}=0
                languageField = sys_language_uid
            }
        }
        # Add page metadata
        meta = JSON
        meta {
            fields {
                title = TEXT
                title.field = title
                
                subtitle = TEXT  
                subtitle.field = subtitle
                
                abstract = TEXT
                abstract.field = abstract
                
                description = TEXT
                description.field = description
                
                keywords = TEXT
                keywords.field = keywords
            }
        }
    }
}

# ==================================================================
# API Libraries for FAHN CORE
# ==================================================================

# Library for Navigation JSON
lib.navigation = JSON
lib.navigation {
    dataProcessing {
        10 = TYPO3\CMS\Frontend\DataProcessing\MenuProcessor
        10 {
            entryLevel = 0
            levels = 2
            as = navigationItems
            dataProcessing {
                10 = FriendsOfTYPO3\Headless\DataProcessing\MenuProcessor
                10 {
                    fields {
                        id = INT
                        id.field = uid

                        title = TEXT
                        title.field = title

                        navTitle = TEXT
                        navTitle.field = nav_title
                        navTitle.ifEmpty.field = title

                        link = TEXT
                        link.typolink.parameter.field = uid
                        link.typolink.returnLast = url

                        active = BOOL
                        active.field = active
                    }
                }
            }
        }
    }
    items = TEXT
    items.data = TSFE:navigationItems
    items.wrap = |
}

# Library for Fahndungen List JSON
lib.fahndungen_list = JSON
lib.fahndungen_list {
    items = TEXT
    items.value = {"items": [{"uid": 1, "title": "Test Fahndung", "path_segment": "test-fahndung"}]}
    items.wrap = |
}

# Library for Fahndung Detail JSON
lib.fahndung_detail = JSON
lib.fahndung_detail {
    dataProcessing {
        10 = TYPO3\CMS\Frontend\DataProcessing\DatabaseQueryProcessor
        10 {
            table = tx_fahndungen_domain_model_fahndung
            where.data = GP:tx_fahncore_pi1[fahndung]
            where.wrap = path_segment='|'
            as = fahndung
            dataProcessing {
                10 = FriendsOfTYPO3\Headless\DataProcessing\RecordProcessor
                10 {
                    fields {
                        uid = INT
                        uid.field = uid
                        title = TEXT
                        title.field = title
                        description = TEXT
                        description.field = description
                        images = MEDIA
                        images {
                            field = assets
                            renderObj = CONTENT_JSON
                            renderObj {
                                fields {
                                    publicUrl = TEXT
                                    publicUrl.data = file:current:publicUrl
                                    alternative = TEXT
                                    alternative.field = alternative
                                    title = TEXT
                                    title.field = title
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    item = TEXT
    item.data = TSFE:fahndung
    item.wrap = |
}

# ==================================================================
# API Endpunkte für Headless JSON-Ausgabe (typeNum-basiert)
# ==================================================================

# PRODUKTIONSREIFE KONFIGURATION: Seiten-JSON (typeNum 9999)
page_api = PAGE
page_api {
    typeNum = 9999
    config {
        disableAllHeaderCode = 1
        additionalHeaders.10 {
            header = Content-Type: application/json; charset=utf-8
            replace = 1
        }
        debug = 0
        admPanel = 0
        cache_period = 3600
        sendCacheHeaders = 1
    }
    10 = JSON
    10 {
        fields {
            # Test field to verify it's working
            test = TEXT
            test.value = API Route Working via type=9999
            
            # Page info
            page = JSON
            page {
                fields {
                    id = TEXT
                    id.data = TSFE:id
                    
                    title = TEXT
                    title.field = title
                }
            }
            
            # Content elements
            content = CONTENT_JSON
            content {
                table = tt_content
                select {
                    orderBy = sorting
                    where = {#colPos}=0
                    languageField = sys_language_uid
                }
            }
        }
    }
}

# Navigations-JSON (typeNum 835)
navigation_api = PAGE
navigation_api {
    typeNum = 835
    config {
        disableAllHeaderCode = 1
        additionalHeaders.10 {
            header = Content-Type: application/json; charset=utf-8
            replace = 1
        }
        sendCacheHeaders = 1
        debug = 0
        admPanel = 0
    }
    # JSON-Objekt direkt verwenden
    10 = JSON
    10 < lib.navigation
}

# Fahndungen-Liste (typeNum 836)
fahndungen_list_api = PAGE
fahndungen_list_api {
    typeNum = 836
    config {
        disableAllHeaderCode = 1
        additionalHeaders.10 {
            header = Content-Type: application/json; charset=utf-8
            replace = 1
        }
        no_cache = 1
        sendCacheHeaders = 1
        debug = 0
        admPanel = 0
    }
    # JSON-Objekt direkt verwenden
    10 = JSON
    10 < lib.fahndungen_list
}

# Fahndung-Detail (typeNum 837)
fahndung_detail_api = PAGE
fahndung_detail_api {
    typeNum = 837
    config {
        disableAllHeaderCode = 1
        additionalHeaders.10 {
            header = Content-Type: application/json; charset=utf-8
            replace = 1
        }
        sendCacheHeaders = 1
        debug = 0
        admPanel = 0
    }
    # JSON-Objekt direkt verwenden
    10 = JSON
    10 < lib.fahndung_detail
}

# JSON 404 Not Found (typeNum 838)
json_404_api = PAGE
json_404_api {
    typeNum = 838
    config {
        disableAllHeaderCode = 1
        additionalHeaders.10 {
            header = HTTP/1.1 404 Not Found
            replace = 1
        }
        additionalHeaders.20.header = Content-Type: application/json
    }
    10 = TEXT
    10.value = {"error": "Not Found", "status": 404}
    10.wrap = |
}

# PRODUKTIONSREIFE KONFIGURATION: Fahndungen-Liste API (typeNum 10000)
page_fahndungen_list = PAGE
page_fahndungen_list {
    typeNum = 10000
    config {
        disableAllHeaderCode = 1
        additionalHeaders.10 {
            header = Content-Type: application/json; charset=utf-8
            replace = 1
        }
        debug = 0
        admPanel = 0
        no_cache = 1
        sendCacheHeaders = 1
    }
    10 = JSON
    10 {
        fields {
            meta = JSON
            meta {
                fields {
                    total = TEXT
                    total.value = 3
                    # TODO: Später durch echte DB-Query ersetzen
                    
                    page = TEXT
                    page.value = 1
                    
                    pageSize = TEXT
                    pageSize.value = 10
                    
                    lastUpdated = TEXT
                    lastUpdated.data = date:U
                }
            }
            
            items = TEXT
            items.value = [{"id": "1", "title": "Vermisste Person: Max Mustermann", "type": "missing_person", "status": "active", "publishedAt": "2025-12-01T10:00:00Z", "slug": "max-mustermann-vermisst", "summary": "Seit 30.11.2025 wird Max Mustermann vermisst. Letzte Sichtung am Hauptbahnhof.", "description": "Seit 30.11.2025 wird Max Mustermann vermisst. Letzte Sichtung am Hauptbahnhof."}, {"id": "2", "title": "Zeugenaufruf: Verkehrsunfall B123", "type": "witness_appeal", "status": "active", "publishedAt": "2025-11-29T14:30:00Z", "slug": "verkehrsunfall-b123-zeugenaufruf", "summary": "Gesucht werden Zeugen eines Verkehrsunfalls auf der B123 am 28.11.2025.", "description": "Gesucht werden Zeugen eines Verkehrsunfalls auf der B123 am 28.11.2025."}, {"id": "3", "title": "Fahndung nach Einbruch in Musterstadt", "type": "wanted", "status": "active", "publishedAt": "2025-11-28T09:15:00Z", "slug": "einbruch-musterstadt-fahndung", "summary": "Nach einem Einbruch in der Musterstraße werden Hinweise zu verdächtigen Personen gesucht.", "description": "Nach einem Einbruch in der Musterstraße werden Hinweise zu verdächtigen Personen gesucht."}]
        }
    }
}

# Health Check API (typeNum 8999)
health_check_api = PAGE
health_check_api {
    typeNum = 8999
    config {
        disableAllHeaderCode = 1
        additionalHeaders.10 {
            header = Content-Type: application/json; charset=utf-8
            replace = 1
        }
        debug = 0
        admPanel = 0
        no_cache = 1
        sendCacheHeaders = 0
    }
    10 = TEXT
    10.value = {"status":"healthy","timestamp":"1764663250","version":"1.0.0","services":{"typo3":"ok","database":"ok","cache":"ok"}}
}
